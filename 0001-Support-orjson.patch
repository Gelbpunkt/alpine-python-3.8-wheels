From 48f8e194e3d31fd2421686194f6874a3afccc3b4 Mon Sep 17 00:00:00 2001
From: Jens Reidel <adrian@travitia.xyz>
Date: Sun, 26 Sep 2021 10:52:34 +0200
Subject: [PATCH 1/1] Support orjson

---
 discord/http.py  |  4 ++--
 discord/utils.py | 14 +++-----------
 requirements.txt |  2 +-
 3 files changed, 6 insertions(+), 14 deletions(-)

diff --git a/discord/http.py b/discord/http.py
index 7a4c2adc..d37a9c67 100644
--- a/discord/http.py
+++ b/discord/http.py
@@ -194,7 +194,7 @@ class HTTPClient:
             'proxy_auth': self.proxy_auth,
             'proxy': self.proxy,
             'max_msg_size': 0,
-            'timeout': 30.0,
+            'timeout': aiohttp.client_ws.ClientWSTimeout(ws_close=30.0),
             'autoclose': False,
             'headers': {
                 'User-Agent': self.user_agent,
@@ -494,7 +494,7 @@ class HTTPClient:
         if stickers:
             payload['sticker_ids'] = stickers
 
-        form.append({'name': 'payload_json', 'value': utils._to_json(payload)})
+        form.append({'name': 'payload_json', 'value': utils._to_json(payload).decode("utf-8")})
         if len(files) == 1:
             file = files[0]
             form.append(
diff --git a/discord/utils.py b/discord/utils.py
index 4360b77a..929c4c48 100644
--- a/discord/utils.py
+++ b/discord/utils.py
@@ -482,19 +482,11 @@ def _bytes_to_base64_data(data: bytes) -> str:
     return fmt.format(mime=mime, data=b64)
 
 
-if HAS_ORJSON:
+def _to_json(obj: Any) -> str:  # type: ignore
+    return orjson.dumps(obj)
 
-    def _to_json(obj: Any) -> str:  # type: ignore
-        return orjson.dumps(obj).decode('utf-8')
 
-    _from_json = orjson.loads  # type: ignore
-
-else:
-
-    def _to_json(obj: Any) -> str:
-        return json.dumps(obj, separators=(',', ':'), ensure_ascii=True)
-
-    _from_json = json.loads
+_from_json = orjson.loads  # type: ignore
 
 
 def _parse_ratelimit_header(request: Any, *, use_clock: bool = False) -> float:
diff --git a/requirements.txt b/requirements.txt
index 8517fb4d..d304ced4 100644
--- a/requirements.txt
+++ b/requirements.txt
@@ -1 +1 @@
-aiohttp>=3.6.0,<3.8.0
+aiohttp==4.0.0a1
-- 
2.31.1

